kind: pipeline
type: kubernetes
steps:
  - name: test
    image: node:alpine
    commands:
      - cd server
      - npm install
      - npm audit
  - name: docker
    image: plugins/kaniko
    environment:
      PLUGIN_USERNAME:
        from_secret: docker_username
      PLUGIN_PASSWORD:
        from_secret: docker_password
      PLUGIN_TAGS: server
      PLUGIN_REPO: munhunger/auth
      PLUGIN_DOCKERFILE: server/Dockerfile
    settings:
      context: server
  - name: deploy
    image: sinlead/drone-kubectl
    commands:
      - kubectl --namespace="auth" rollout restart node
